<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åŒ—ç¾æ–©æ€çº¿æ¨¡æ‹Ÿå™¨ â€” ç©å®¶ç‰ˆ</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --panel2:#0c1320; --bd:#1f2a37;
      --text:#e6edf3; --muted:#9fb0c0;
      --good:#22c55e; --mid:#f59e0b; --bad:#ef4444;
      --accent:#60a5fa;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); overflow-x:hidden; }
    header{
      position:sticky; top:0; z-index:10;
      padding:14px 16px; border-bottom:1px solid var(--bd);
      background: rgba(11,15,20,.92); backdrop-filter: blur(8px);
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .title{ font-weight:750; letter-spacing:.2px; }
    .sub{ font-size:12px; color:var(--muted); line-height:1.35; }
    .wrap{ display:grid; grid-template-columns: 360px 1fr; gap:12px; padding:12px; }
    @media (max-width: 980px){ .wrap{ grid-template-columns:1fr; } }
    .panel{ background:var(--panel); border:1px solid var(--bd); border-radius:16px; padding:12px; box-shadow: 0 10px 24px rgba(0,0,0,.22); }
    .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .btn{
      border:1px solid #2b3a4b; background:#111a25; color:var(--text);
      padding:9px 11px; border-radius:12px; cursor:pointer; font-size:12px;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{ border-color:#3a4f66; transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px) scale(.98); }
    .btn.primary{ background:#152235; border-color:#3b82f6; }
    .btn.danger{ background:#2a1416; border-color:#ef4444; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    input[type=file]{ color:var(--muted); font-size:12px; max-width: 160px; }
    .pill{ border:1px solid #2b3a4b; background:#0c1320; color:#c7d2de; padding:2px 8px; border-radius:999px; font-size:12px; }
    .hr{ height:1px; background:var(--bd); margin:10px 0; }

    /* status lights */
    .lights{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .light{
      border:1px solid #233044; background:var(--panel2); border-radius:14px; padding:10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .light .k{ font-size:12px; color:var(--muted); }
    .dot{ width:12px; height:12px; border-radius:999px; background: #334155; box-shadow: 0 0 0 3px rgba(255,255,255,.04) inset; }
    .dot.good{ background: var(--good); box-shadow: 0 0 16px rgba(34,197,94,.35); }
    .dot.mid{ background: var(--mid); box-shadow: 0 0 16px rgba(245,158,11,.35); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 16px rgba(239,68,68,.35); }
    .moneyBox{
      border:1px solid #233044; background:linear-gradient(180deg,#0c1320,#0f1620);
      border-radius:16px; padding:12px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
    }
    .moneyBox .label{ font-size:12px; color:var(--muted); }
    .moneyBox .val{ font-size:26px; font-weight:800; letter-spacing:.2px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-variant-numeric: tabular-nums; font-feature-settings:"tnum"; }

    /* states list */
    .states{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .stateChip{
      border:1px solid #223245; background:#0c1320; border-radius:14px; padding:10px;
      display:flex; gap:10px; align-items:flex-start;
      opacity:1; transform: translateY(0);
      transition: opacity .35s ease, transform .35s ease, border-color .15s ease;
    }
    .stateChip:hover{ border-color:#3a4f66; }
    .stateChip.fadeIn{ animation: fadeIn .38s ease both; }
    .stateChip.fadeOut{ opacity:0; transform: translateY(8px); }
    .sIcon{ font-size:18px; width:24px; text-align:center; margin-top:1px; }
    .sText .name{ font-weight:700; font-size:12px; }
    .sText .desc{ font-size:12px; color:var(--muted); line-height:1.35; margin-top:2px; }

    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* card */
    .stage{ position:relative; min-height: 520px; }
    .card{
      border:1px solid #233044; background: radial-gradient(1200px 600px at 40% -10%, rgba(96,165,250,.18), transparent 55%),
                                 linear-gradient(180deg,#0c1320,#0f1620);
      border-radius:18px; padding:16px;
      box-shadow: 0 18px 44px rgba(0,0,0,.35);
      transform-origin: 50% 80%;
      animation: cardIn .35s ease both;
    }
    .card.out{ animation: cardOut .32s ease both; }
    @keyframes cardIn{
      from{ opacity:0; transform: translateY(14px) scale(.985) rotate(-.6deg); }
      to{ opacity:1; transform: translateY(0) scale(1) rotate(0deg); }
    }
    @keyframes cardOut{
      from{ opacity:1; transform: translateY(0) scale(1); }
      to{ opacity:0; transform: translateY(-10px) scale(.985); }
    }
    .cardHeader{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .cardTitle{ font-size:18px; font-weight:850; letter-spacing:.15px; margin:0; }
    .meta{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .meta .pill{ opacity:.9; }
    .cardText{ margin-top:10px; font-size:14px; color:#c7d2de; line-height:1.55; white-space:pre-wrap; }

    .choices{ display:flex; flex-direction:column; gap:10px; margin-top:14px; }
    .choice{
      border:1px solid #223245; background: rgba(12,19,32,.6);
      border-radius:16px; padding:12px 12px;
      cursor:pointer;
      transition: transform .10s ease, border-color .15s ease, background .15s ease, opacity .25s ease;
      position:relative;
      overflow:hidden;
    }
    .choice:hover{ border-color:#3a4f66; transform: translateY(-1px); }
    .choice:active{ transform: translateY(0) scale(.99); }
    .choice .t{ font-weight:750; font-size:14px; }
    .choice .hint{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35; }
    .choice.chosen{
      border-color: var(--accent);
      background: rgba(96,165,250,.12);
      animation: chosenPulse .28s ease both;
    }
    @keyframes chosenPulse{
      0%{ transform: translateY(-1px) scale(1.01); }
      100%{ transform: translateY(0) scale(1); }
    }
    .choice.vanish{
      opacity:0; transform: translateX(30px) scale(.98);
      filter: blur(1px);
    }
    .choice.lock{ pointer-events:none; }

    /* feedback */
    .toast{
      position:absolute; left:50%; top:18px; transform:translateX(-50%);
      padding:10px 12px; border-radius:14px;
      border:1px solid #2b3a4b; background: rgba(12,19,32,.92);
      color:#e6edf3; font-size:12px; line-height:1.35;
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
      opacity:0; pointer-events:none;
    }
    .toast.show{ animation: toastInOut 1.25s ease both; }
    @keyframes toastInOut{
      0%{ opacity:0; transform: translateX(-50%) translateY(-6px); }
      15%{ opacity:1; transform: translateX(-50%) translateY(0); }
      85%{ opacity:1; transform: translateX(-50%) translateY(0); }
      100%{ opacity:0; transform: translateX(-50%) translateY(-6px); }
    }

    .shake{ animation: shake .22s ease both; }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-6px); }
      50%{ transform: translateX(6px); }
      75%{ transform: translateX(-4px); }
      100%{ transform: translateX(0); }
    }
    .flashRed{ box-shadow: 0 0 0 0 rgba(239,68,68,0); animation: flashRed .38s ease both; }
    @keyframes flashRed{
      0%{ box-shadow: 0 0 0 0 rgba(239,68,68,0); }
      30%{ box-shadow: 0 0 0 8px rgba(239,68,68,.10); }
      100%{ box-shadow: 0 0 0 0 rgba(239,68,68,0); }
    }
    .flashGreen{ box-shadow: 0 0 0 0 rgba(34,197,94,0); animation: flashGreen .38s ease both; }
    @keyframes flashGreen{
      0%{ box-shadow: 0 0 0 0 rgba(34,197,94,0); }
      30%{ box-shadow: 0 0 0 8px rgba(34,197,94,.10); }
      100%{ box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }

    /* end screen */
    .overlay{
      position:fixed; inset:0; background: rgba(3,6,10,.72);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:50;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(920px, 100%); max-height: 92vh; overflow:auto;
      background: linear-gradient(180deg,#0c1320,#0f1620);
      border:1px solid #233044; border-radius:18px; padding:16px;
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      animation: cardIn .28s ease both;
    }
    .modal h2{ margin:0; font-size:18px; }
    .modal .lead{ margin-top:8px; color:#c7d2de; line-height:1.55; white-space:pre-wrap; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
    @media (max-width: 900px){ .grid2{ grid-template-columns:1fr; } }
    .mini{
      border:1px solid #223245; background:#0c1320; border-radius:16px; padding:12px;
    }
    .mini .t{ font-weight:800; font-size:12px; color:#c7d2de; }
    .mini ul{ margin:8px 0 0; padding-left: 18px; color:var(--muted); font-size:12px; line-height:1.5; }
  </style>
</head>
<body>
<header>
  <div>
    <div class="title">åŒ—ç¾æ–©æ€çº¿æ¨¡æ‹Ÿå™¨ â€” ç©å®¶ç‰ˆ</div>
    <div class="sub">ä½ æ¯æ¬¡åªèƒ½æŠ½åˆ°ä¸€å¼ ç‰Œã€‚ä½ åšçš„é€‰æ‹©ä¸å¯é€†ã€‚å‘½è¿ä¼šè®°è´¦ï¼Œä½†å®ƒä¸ä¼šæŠŠè´¦æœ¬ç»™ä½ çœ‹ã€‚</div>
  </div>
  <div class="row">
    <input id="fileEvents" type="file" accept=".json" />
    <input id="fileStates" type="file" accept=".json" />
    <input id="fileConfig" type="file" accept=".json" />
    <button class="btn" id="btnLoad">åŠ è½½</button>
    <button class="btn primary" id="btnNew" disabled>å¼€å§‹äººç”Ÿ</button>
    <button class="btn danger" id="btnReset" disabled>é‡ç½®</button>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <div class="moneyBox" id="moneyBox">
      <div>
        <div class="label">ç°é‡‘æµ</div>
        <div class="sub">ä½ åªçŸ¥é“è¿™ä¸ªã€‚å…¶ä»–éƒ½å¾—é æ„Ÿè§‰ã€‚</div>
      </div>
      <div class="val mono" id="moneyVal">â€”</div>
    </div>

    <div class="lights">
      <div class="light"><div class="k">å¥åº·</div><div class="dot" id="dotHealth"></div></div>
      <div class="light"><div class="k">å‹åŠ›</div><div class="dot" id="dotStress"></div></div>
      <div class="light"><div class="k">å®¶åº­</div><div class="dot" id="dotFamily"></div></div>
      <div class="light"><div class="k">å‹æƒ…</div><div class="dot" id="dotFriend"></div></div>
    </div>

    <div class="hr"></div>

    <div class="row" style="justify-content:space-between">
      <div class="pill">çŠ¶æ€</div>
      <div class="sub" id="progressText">â€”</div>
    </div>
    <div class="states" id="stateList"></div>

    <div class="hr"></div>
    <div class="sub">
      å°æç¤ºï¼šå½“ä½ çœ‹åˆ°ä¸€å †çŠ¶æ€å¼€å§‹æ’é˜Ÿï¼Œå°±åƒä½ æ‰‹æœºé‡ŒåŒæ—¶å“èµ·çš„æ¨é€â€¦ é€šå¸¸ä¸æ˜¯ä»€ä¹ˆå¥½äº‹ã€‚
    </div>
  </div>

  <div class="panel stage" id="stage">
    <div class="toast" id="toast"></div>
    <div id="cardHost"></div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <div class="row" style="justify-content:space-between">
      <h2 id="endTitle">â€”</h2>
      <button class="btn primary" id="btnAgain">å†æ¥ä¸€å±€</button>
    </div>
    <div class="lead" id="endBody"></div>

    <div class="grid2">
      <div class="mini">
        <div class="t">ä½ è¿™ä¸€å±€çš„å…³é”®è¯</div>
        <ul id="endBullets"></ul>
      </div>
      <div class="mini">
        <div class="t">å‘½è¿çš„æ—ç™½</div>
        <ul id="endNarrator"></ul>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== Core helpers & engine (same numbers, hidden UI) ====== */
const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const fmtMoney=(n)=>{ const sign=n<0?"-":""; const x=Math.abs(Math.round(n)); return sign + x.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g,","); };
const pickWeighted=(items,weights)=>{ let total=0; for(const w of weights) total+=w; let r=Math.random()*total, acc=0; for(let i=0;i<items.length;i++){ acc+=weights[i]; if(r<=acc) return items[i]; } return items[items.length-1]; };
const deepCopy=(x)=>JSON.parse(JSON.stringify(x));

let EVENTS=null, STATES=null, CONFIG=null;
let pools=null, stateIndex=null, eventIndex=null;

const TAGS=["job","debt","housing","health","social","admin","car","money"];
const STATE_TAG_MULT={
  "S_LAYOFF": {"job": 1.6, "debt": 1.35, "money": 0.9, "social": 0.95},
  "S_RENT_ARREARS": {"housing": 1.7, "debt": 1.25, "job": 1.1},
  "S_HIGH_INTEREST_LOAN": {"debt": 1.55, "money": 0.85},
  "S_CREDIT_CARD_DEBT": {"debt": 1.25, "money": 0.92},
  "S_INJURED": {"health": 1.55, "job": 0.95},
  "S_HEALTH_SCARE": {"health": 1.35, "admin": 1.1},
  "S_IMMIGRATION_ISSUE": {"admin": 1.55, "job": 1.1},
  "S_CAR_BROKEN": {"car": 1.8, "job": 1.05},
  "S_SOCIAL_ISOLATION": {"social": 1.45, "health": 1.1},
  "S_WINDFALL_BUFFER": {"debt": 0.88, "housing": 0.92, "money": 1.12},
  "S_RENT_DUE": {"housing": 2.2},
  "S_TAX_DUE": {"admin": 2.0},
  "S_TRAFFIC_TICKET": {"car": 1.6, "admin": 1.15},
  "S_COLLECTIONS_NOTICE": {"debt": 1.4, "admin": 1.2},
};

const STATE_ICON={
  "S_RENT_DUE":"ğŸ ","S_RENT_ARREARS":"ğŸšª","S_CREDIT_CARD_DEBT":"ğŸ’³","S_HIGH_INTEREST_LOAN":"ğŸ¦ˆ",
  "S_MEDICAL_DEBT":"ğŸ¥","S_OVERDRAFT":"ğŸ¦","S_LAYOFF":"ğŸ“‰","S_NEW_JOB":"ğŸ†•","S_OVERTIME":"â±ï¸",
  "S_SIDE_GIG":"ğŸ›µ","S_PAYCHECK":"ğŸ’µ","S_INJURED":"ğŸ©¹","S_CHRONIC_PAIN":"ğŸ¦´","S_SLEEP_DEPRIVED":"ğŸ˜´",
  "S_UNINSURED":"ğŸ§¾","S_THERAPY":"ğŸ›‹ï¸","S_GYM_HABIT":"ğŸ‹ï¸","S_SMOKING":"ğŸš¬","S_HEALTH_SCARE":"ğŸš‘",
  "S_FAMILY_CRISIS":"ğŸ‘ª","S_PARENTING_BURN":"ğŸ§¸","S_BEST_FRIEND_SUPPORT":"ğŸ¤","S_SUPPORTIVE_PARTNER":"ğŸ’",
  "S_SOCIAL_ISOLATION":"ğŸ•³ï¸","S_CAR_BROKEN":"ğŸš—","S_TRAFFIC_TICKET":"ğŸš“","S_TAX_DUE":"ğŸ§¾",
  "S_COLLECTIONS_NOTICE":"ğŸ“¬","S_LEGAL_TROUBLE":"âš–ï¸","S_IMMIGRATION_ISSUE":"ğŸ›‚","S_WINDFALL_BUFFER":"ğŸ",
};

function rebuildPools(){ pools={}; for(const t of TAGS) pools[t]=[]; eventIndex={}; for(const ev of EVENTS){ pools[ev.primary_tag].push(ev); eventIndex[ev.id]=ev; } }
function buildStateIndex(){ stateIndex={}; for(const s of STATES) stateIndex[s.id]=s; }

function costFactor(month){ const infl=(CONFIG.economy?.inflation_per_year ?? 0); return Math.pow(1+infl, month/12.0); }
function wageFactor(month){ const wg=(CONFIG.economy?.wage_growth_per_year ?? 0); return Math.pow(1+wg, month/12.0); }
function effectiveGain(baseGain, statValue){
  if (baseGain<=0) return baseGain;
  const alpha=CONFIG.recovery.alpha, floor=CONFIG.recovery.soft_floor;
  const penalty=Math.max(0, floor-statValue);
  return baseGain*Math.exp(-alpha*penalty);
}
function applyEffects(stats, eff){
  for(const [k,dv] of Object.entries(eff)){
    if(!(k in stats)) continue;
    stats[k]+=dv;
    if(["health","stress","family","friendship"].includes(k)) stats[k]=Math.round(clamp(stats[k],0,100));
  }
}
function addState(active, sid){
  const sdef=stateIndex[sid]; if(!sdef) return;
  if (sdef.type==="counter"){ if(!active[sid]) active[sid]={remaining:null}; return; }
  const dur=(sdef.duration ?? null);
  if (dur===null){ if(!active[sid]) active[sid]={remaining:null}; return; }
  if(active[sid]){
    const behavior=sdef.stacking ?? "refresh";
    if(behavior==="extend" && active[sid].remaining!=null) active[sid].remaining += dur;
    else active[sid].remaining = dur;
  } else active[sid]={remaining:dur};
}
function removeState(active, sid){ delete active[sid]; }

function monthlyPassive(stats){
  const mp=CONFIG.recovery.monthly_passive;
  const baseH=mp.health_base_regen*(1.0-stats.stress/140.0);
  const dh=effectiveGain(baseH, stats.health);
  const baseS=mp.stress_base_decay*(0.6+stats.health/140.0+stats.friendship/250.0);
  const ds=-baseS;
  const baseR=mp.relationship_base_regen*(1.0-stats.stress/140.0);
  const dr=effectiveGain(baseR, stats.family);
  const df=effectiveGain(baseR, stats.friendship);
  applyEffects(stats,{health:Math.round(dh), stress:Math.round(ds), family:Math.round(dr), friendship:Math.round(df)});
}
function applyStateMonthly(stats, active, counters, month){
  const cf=costFactor(month), wf=wageFactor(month);
  for(const sid of Object.keys(active)){
    const sdef=stateIndex[sid]; if(!sdef) continue;
    if (sid==="S_PAYCHECK" && active["S_LAYOFF"]) {
      // no paycheck
    } else {
      const eff=sdef.monthly_effect ?? {};
      const eff2={};
      for(const [k,v] of Object.entries(eff)){
        if(["health","family","friendship"].includes(k) && v>0) eff2[k]=Math.round(effectiveGain(v, stats[k]));
        else if (k==="money" && v>0 && active["S_HIGH_INTEREST_LOAN"]) eff2[k]=Math.round(v*0.85);
        else eff2[k]=v;
      }
      if ("money" in eff2){
        let m=eff2.money;
        if(m>0) m=m*CONFIG.balance.pos_money_mult*wf;
        else m=m*CONFIG.balance.neg_money_mult*cf;
        eff2.money=Math.round(m);
      }
      if ("stress" in eff2) eff2.stress=Math.round(eff2.stress*CONFIG.balance.stress_mult);
      applyEffects(stats, eff2);
    }
    if (sdef.type==="counter"){
      if (sid==="S_RENT_ARREARS") counters.rent_arrears_months=(counters.rent_arrears_months ?? 0)+1;
      continue;
    }
    if (active[sid].remaining!=null){
      active[sid].remaining -= 1;
      if (active[sid].remaining <= 0) delete active[sid];
    }
  }
}
function tagWeights(active){
  const w={}; for(const t of TAGS) w[t]=1.0;
  for(const sid of Object.keys(active)){
    const mods=STATE_TAG_MULT[sid]; if(!mods) continue;
    for(const [t,m] of Object.entries(mods)){ if (t in w) w[t]*=m; }
  }
  for(const t of TAGS) w[t]=clamp(w[t],0.75,1.55);
  return w;
}
function drawEvent(){
  const tw=tagWeights(game.active);
  const tags=Object.keys(tw);
  const tag=pickWeighted(tags, tags.map(t=>tw[t]));
  const pool=pools[tag];

  const beta=CONFIG.draw.anti_repeat_beta;
  const recentWin=CONFIG.draw.recent_window;
  const recentPenalty=CONFIG.draw.recent_penalty;
  const recentSet=new Set(game.recent.slice(Math.max(0, game.recent.length-recentWin)));

  const cand=[], ws=[];
  for(const ev of pool){
    const seen=game.seenCounts[ev.id] ?? 0;
    let w=(ev.base_weight ?? 1.0)/Math.pow(1.0+seen,beta);
    if(recentSet.has(ev.id)) w*=recentPenalty;
    cand.push(ev); ws.push(w);
  }
  return pickWeighted(cand, ws);
}
function strikesNow(){
  let s=0;
  if (game.stats.money < CONFIG.thresholds.money_hard) s++;
  if (game.active["S_RENT_ARREARS"] && (game.counters.rent_arrears_months ?? 0) >= CONFIG.thresholds.eviction_months) s++;
  if (game.stats.health <= 0) s++;
  if (game.stats.stress >= 100) s++;
  if (game.stats.family <= 0) s++;
  if (game.stats.friendship <= 0) s++;
  return s;
}
function monthEndRent(){
  const rent=Math.round(CONFIG.economy.rent*costFactor(game.month));
  if (game.active["S_RENT_DUE"]){
    if (game.stats.money >= rent){
      applyEffects(game.stats, {money:-rent, stress:-1});
      removeState(game.active, "S_RENT_DUE");
      game.highlights.push({k:"rent_paid", m:game.month});
    } else {
      removeState(game.active, "S_RENT_DUE");
      addState(game.active, "S_RENT_ARREARS");
      game.highlights.push({k:"rent_missed", m:game.month});
    }
  }
  addState(game.active, "S_RENT_DUE");
}

function applyChoice(ev, ch){
  const eff=deepCopy(ch.effects ?? {});
  const cf=costFactor(game.month);
  const wf=wageFactor(game.month);

  if (ch.action==="PAY_RENT"){
    const rent=Math.round(CONFIG.economy.rent*cf);
    eff.money=(eff.money ?? 0) - rent;
  }
  for(const k of ["health","family","friendship"]){
    if (k in eff && eff[k] > 0) eff[k]=Math.round(effectiveGain(eff[k], game.stats[k]));
  }
  if ("money" in eff){
    let m=eff.money;
    if (m>0){
      m=m*CONFIG.balance.pos_money_mult*wf;
      if (game.active["S_HIGH_INTEREST_LOAN"]) m*=0.85;
    } else {
      m=m*CONFIG.balance.neg_money_mult*cf;
    }
    eff.money=Math.round(m);
  }
  if ("stress" in eff) eff.stress=Math.round(eff.stress*CONFIG.balance.stress_mult);

  // track for ending
  game.tagCounts[ev.primary_tag]=(game.tagCounts[ev.primary_tag] ?? 0)+1;
  game.choiceTexts.push({ev:ev.title, ch:ch.desc, tag:ev.primary_tag, id:ev.id});

  // apply
  applyEffects(game.stats, eff);

  const added=[];
  for(const sid of (ch.add_states ?? [])){ addState(game.active, sid); added.push(sid); }
  const removed=[];
  for(const sid of (ch.remove_states ?? [])){
    removeState(game.active, sid); removed.push(sid);
    if (sid==="S_RENT_ARREARS") game.counters.rent_arrears_months=0;
  }

  // update seen
  game.seenCounts[ev.id]=(game.seenCounts[ev.id] ?? 0)+1;
  game.seenSet.add(ev.id);
  game.recent.push(ev.id);
  if (game.recent.length>60) game.recent=game.recent.slice(-60);

  game.turnInMonth += 1;

  return { eff, added, removed };
}

function startMonthIfNeeded(){
  if (game.turnInMonth===0){
    monthlyPassive(game.stats);
    applyStateMonthly(game.stats, game.active, game.counters, game.month);
  }
}
function endMonthIfNeeded(){
  if (game.turnInMonth >= CONFIG.turns_per_month){
    monthEndRent();
    game.month += 1;
    game.turnInMonth = 0;
    if (game.month >= CONFIG.max_months){
      game.ended=true; game.win=true;
      return "WIN";
    }
  }
  return null;
}

/* ====== Player-facing UI ====== */
const elMoney=document.getElementById("moneyVal");
const dotHealth=document.getElementById("dotHealth");
const dotStress=document.getElementById("dotStress");
const dotFamily=document.getElementById("dotFamily");
const dotFriend=document.getElementById("dotFriend");
const stateList=document.getElementById("stateList");
const cardHost=document.getElementById("cardHost");
const stage=document.getElementById("stage");
const toast=document.getElementById("toast");
const progressText=document.getElementById("progressText");

function tierForPositiveStat(v){
  if (v >= 70) return "good";
  if (v >= 40) return "mid";
  return "bad";
}
function tierForStress(v){
  if (v <= 35) return "good";
  if (v <= 70) return "mid";
  return "bad";
}
function setDot(dot, tier){
  dot.className = "dot " + tier;
}
function updateDashboard(){
  elMoney.textContent = fmtMoney(game.stats.money);

  setDot(dotHealth, tierForPositiveStat(game.stats.health));
  setDot(dotStress, tierForStress(game.stats.stress));
  setDot(dotFamily, tierForPositiveStat(game.stats.family));
  setDot(dotFriend, tierForPositiveStat(game.stats.friendship));

  progressText.textContent = `ç¬¬ ${game.month+1} ä¸ªæœˆ Â· ç¬¬ ${game.turnInMonth+1}/${CONFIG.turns_per_month} æ¬¡æŠ‰æ‹©`;

  renderStates();
}
function stateKeySet(){ return new Set(Object.keys(game.active)); }

function renderStates(){
  const current = stateKeySet();
  const prev = game.uiPrevStates ?? new Set();
  game.uiPrevStates = new Set(current);

  // remove vanished
  for (const chip of Array.from(stateList.querySelectorAll(".stateChip"))){
    const sid = chip.getAttribute("data-sid");
    if (!current.has(sid)){
      chip.classList.add("fadeOut");
      setTimeout(()=>chip.remove(), 360);
    }
  }
  // add new
  for (const sid of current){
    if (prev.has(sid)) continue;
    const def = stateIndex[sid];
    const icon = STATE_ICON[sid] ?? "ğŸ§©";
    const chip = document.createElement("div");
    chip.className = "stateChip fadeIn";
    chip.setAttribute("data-sid", sid);
    chip.innerHTML = `
      <div class="sIcon">${icon}</div>
      <div class="sText">
        <div class="name">${def?.name ?? sid}</div>
        <div class="desc">${def?.desc ?? ""}</div>
      </div>
    `;
    stateList.prepend(chip);
  }

  if (!Object.keys(game.active).length && !stateList.children.length){
    stateList.innerHTML = `<div class="sub">æš‚æ— çŠ¶æ€ã€‚æ­¤åˆ»ä½ ç”šè‡³æœ‰ç‚¹ä¸ä¹ æƒ¯ã€‚</div>`;
  }
}

function showToast(msg){
  toast.textContent = msg;
  toast.classList.remove("show");
  void toast.offsetWidth;
  toast.classList.add("show");
}

function vibeFromDelta(eff){
  // We don't show numbers. We infer "feelings" from deltas.
  let score = 0;
  const m = eff.money ?? 0;
  const h = eff.health ?? 0;
  const s = eff.stress ?? 0;
  const f = eff.family ?? 0;
  const fr = eff.friendship ?? 0;

  score += Math.sign(m) * Math.min(3, Math.abs(m)/600);
  score += Math.sign(h) * Math.min(2, Math.abs(h)/10);
  score += -Math.sign(s) * Math.min(2, Math.abs(s)/10);
  score += Math.sign(f) * Math.min(1.5, Math.abs(f)/10);
  score += Math.sign(fr) * Math.min(1.5, Math.abs(fr)/10);

  if (score >= 3) return {msg:"ä½ æ„Ÿè§‰ä¸–ç•Œçªç„¶å¯¹ä½ å‹å–„äº†ä¸€ç‚¹ã€‚", kind:"good"};
  if (score >= 1.2) return {msg:"ä½ æ¾äº†ä¸€å£æ°”ï¼Œä½†ä¸æ•¢å¤ªæ—©åº†ç¥ã€‚", kind:"good"};
  if (score <= -3) return {msg:"ä½ å¿ƒé‡Œä¸€æ²‰ï¼Œåƒæ˜¯æŠŠæœªæ¥æå‰é€æ”¯äº†ã€‚", kind:"bad"};
  if (score <= -1.2) return {msg:"ä½ å¼€å§‹æ€€ç–‘è‡ªå·±æ˜¯ä¸æ˜¯é€‰é”™äº†ã€‚", kind:"bad"};
  return {msg:"è¿™æ¬¡çœ‹èµ·æ¥å¹³å¹³æ— å¥‡ï¼Œä½†äººç”Ÿçš„å‘é€šå¸¸éƒ½è¿™ä¹ˆå¼€å§‹ã€‚", kind:"mid"};
}

function renderCard(ev){
  cardHost.innerHTML = "";
  const card = document.createElement("div");
  card.className = "card";
  card.setAttribute("data-eid", ev.id);
  card.innerHTML = `
    <div class="cardHeader">
      <h3 class="cardTitle">${ev.title}</h3>
      <div class="meta">
        <span class="pill">å‘½è¿å‘ç‰Œ</span>
        <span class="pill">${game.month+1}æœˆ</span>
      </div>
    </div>
    <div class="cardText">${ev.text}</div>
    <div class="choices"></div>
  `;
  const choicesEl = card.querySelector(".choices");
  ev.choices.forEach((ch, idx)=>{
    const c = document.createElement("div");
    c.className = "choice";
    c.innerHTML = `
      <div class="t">${idx+1}. ${ch.desc}</div>
      <div class="hint">ç‚¹å‡»å³ç”Ÿæ•ˆã€‚å…¶ä»–å¯èƒ½æ€§ä¼šæ¶ˆå¤±ã€‚</div>
    `;
    c.onclick = ()=>choose(card, ev, ch, c);
    choicesEl.appendChild(c);
  });

  cardHost.appendChild(card);
}

let inputLocked = false;

function choose(cardEl, ev, ch, chosenEl){
  if (inputLocked || game.ended) return;
  inputLocked = true;

  // UI: chosen pulse, others vanish
  const all = Array.from(cardEl.querySelectorAll(".choice"));
  for (const el of all){
    el.classList.add("lock");
    if (el === chosenEl) el.classList.add("chosen");
    else el.classList.add("vanish");
  }

  // Apply after a short "decision" beat
  setTimeout(()=>{
    startMonthIfNeeded();

    const beforeMoney = game.stats.money;
    const beforeStates = new Set(Object.keys(game.active));
    const {eff, added, removed} = applyChoice(ev, ch);

    // vibey feedback + punch
    const vibe = vibeFromDelta(eff);
    showToast(vibe.msg);

    const deltaMoney = game.stats.money - beforeMoney;
    if (vibe.kind === "bad"){
      stage.classList.remove("shake","flashRed");
      void stage.offsetWidth;
      stage.classList.add("shake","flashRed");
    } else if (vibe.kind === "good"){
      stage.classList.remove("flashGreen");
      void stage.offsetWidth;
      stage.classList.add("flashGreen");
    }

    // Also note "new/removed state" explicitly (without numbers)
    if (added.length){
      game.highlights.push({k:"state_add", m:game.month, s: added[0]});
    }
    if (removed.length){
      game.highlights.push({k:"state_remove", m:game.month, s: removed[0]});
    }
    if (deltaMoney <= -1500) game.highlights.push({k:"big_spend", m:game.month, ev:ev.id});
    if (deltaMoney >= 1500) game.highlights.push({k:"big_gain", m:game.month, ev:ev.id});

    // update dashboard (will animate state diff)
    updateDashboard();

    // check lose/win
    const strikes = strikesNow();
    if (strikes >= CONFIG.thresholds.collections_strikes){
      game.ended = true; game.win = false;
      // animate card out then end
      cardEl.classList.add("out");
      setTimeout(()=>showEnding(), 260);
      return;
    }
    const endSignal = endMonthIfNeeded();
    updateDashboard();

    cardEl.classList.add("out");
    setTimeout(()=>{
      if (game.ended){
        showEnding();
      } else {
        drawAndRenderNext();
        inputLocked = false;
      }
    }, 260);
  }, 260);
}

function drawAndRenderNext(){
  const ev = drawEvent();
  game.lastEventId = ev.id;
  renderCard(ev);
}

function resetUI(){
  cardHost.innerHTML="";
  stateList.innerHTML="";
  hideOverlay();
}

function newGame(){
  game = {
    month: 0,
    turnInMonth: 0,
    stats: {
      money: CONFIG.attrs.money.start,
      health: CONFIG.attrs.health.start,
      stress: CONFIG.attrs.stress.start,
      family: CONFIG.attrs.family.start,
      friendship: CONFIG.attrs.friendship.start,
    },
    active: {},
    counters: { rent_arrears_months: 0 },
    recent: [],
    seenCounts: {},
    seenSet: new Set(),
    ended: false,
    win: false,
    uiPrevStates: new Set(),
    tagCounts: {},
    choiceTexts: [],
    highlights: [],
    lastEventId: null
  };

  addState(game.active, "S_RENT_DUE");
  addState(game.active, "S_PAYCHECK");

  updateDashboard();
  inputLocked = false;
  drawAndRenderNext();
}

/* ====== Endings ====== */
const ENDINGS = [
  {
    id:"WIN_FRUGAL_SENSEI",
    title:"ç»“å±€ï¼šçœé’±å®—å¸ˆ",
    when:(ctx)=>ctx.win && ctx.money>=35000 && ctx.debtLevel<=1 && ctx.stressTier!=="bad",
    body:(ctx)=>`ä½ å±…ç„¶æŠŠåå¹´è¿‡æˆäº†ä¸€å¥—å¯å¤ç”¨çš„é¢„ç®—æ¨¡æ¿ã€‚\n\nä½ ä¸æ˜¯æ²¡é‡åˆ°å‘ï¼Œåªæ˜¯ä½ æ¯æ¬¡éƒ½åœ¨å‘è¾¹ä¸Šåœä½äº†åŠç§’ï¼Œç„¶åæŠŠæ‰‹æœºé”å±ã€‚\n\nåœ¨åˆ«äººç”¨â€œä¹°ä¹°ä¹°â€å¯¹æŠ—ç„¦è™‘çš„æ—¶å€™ï¼Œä½ ç”¨â€œç®—ç®—ç®—â€å¯¹æŠ—å‘½è¿ã€‚å¾ˆçƒ¦ï¼Œä½†æœ‰æ•ˆã€‚`
  },
  {
    id:"WIN_SURVIVOR",
    title:"ç»“å±€ï¼šç¡¬æ’‘å† å†›",
    when:(ctx)=>ctx.win && ctx.stressTier==="bad",
    body:(ctx)=>`ä½ é€šå…³äº†ï¼Œä½†ä½ ä¹ŸæŠŠè‡ªå·±æ´»æˆäº†â€œå¯ä»¥å†æ’‘ä¸€ä¼šå„¿â€çš„å½¢çŠ¶ã€‚\n\né’±æ˜¯æ²¡å°‘æ”’ï¼Œå¯ä½ æ¯æ¬¡ç¬‘éƒ½åƒåœ¨ç»™è‡ªå·±æ‰“æ°”ã€‚\n\næ­å–œä½ èµ¢äº†æ¸¸æˆã€‚ä¹Ÿæé†’ä½ ï¼Œç°å®é‡Œå¯ä»¥å¶å°”æŠŠéš¾åº¦è°ƒä½ä¸€ç‚¹ã€‚`
  },
  {
    id:"WIN_COMMUNITY",
    title:"ç»“å±€ï¼šäººæƒ…å¤–æŒ‚",
    when:(ctx)=>ctx.win && ctx.socialSupport>=3,
    body:(ctx)=>`ä½ æ´»åˆ°äº†æœ€åï¼Œä¸æ˜¯å› ä¸ºä½ ä»ä¸æ‘”è·¤ï¼Œè€Œæ˜¯æ¯æ¬¡æ‘”ä¸‹å»éƒ½æœ‰æ‰‹æŠŠä½ æ‹èµ·æ¥ã€‚\n\næœ‹å‹ã€ä¼´ä¾£ã€å®¶äººåƒéšè— buffï¼Œä¸€å¼€å§‹çœ‹ä¸è§ï¼Œå…³é”®æ—¶åˆ»å…¨éƒ½äº®äº†ã€‚\n\nä½ å­¦ä¼šäº†ä¸€ä¸ªåŒ—ç¾ç”Ÿå­˜æŠ€å·§ï¼šåˆ«åªå­˜é’±ï¼Œä¹Ÿå­˜äººã€‚`
  },
  {
    id:"WIN_LUCKY_BREAK",
    title:"ç»“å±€ï¼šå¹¸è¿åå¼¹",
    when:(ctx)=>ctx.win && ctx.bigGains>=2,
    body:(ctx)=>`ä½ çš„äººç”Ÿåƒè‚¡ç¥¨ï¼šæ³¢åŠ¨å¾ˆå¤§ï¼Œä½†æœ€åæ”¶ç›˜å±…ç„¶æ˜¯ç»¿çš„ã€‚\n\nä½ ç¡®å®æœ‰è¿‡å‡ æ¬¡â€œå¤©é™ç¼“å†²å«â€ï¼Œä½†æ›´é‡è¦çš„æ˜¯ä½ æ²¡æŠŠç¼“å†²å«å½“å¼¹åºŠã€‚\n\nä½ çŸ¥é“è¯¥åœ¨å¥½è¿æ¥çš„æ—¶å€™å°‘è¯´ä¸¤å¥ï¼Œå¤šåšä¸¤ä»¶äº‹ã€‚`
  },

  // Loss endings
  {
    id:"LOSE_EVICTION",
    title:"ç»“å±€ï¼šæˆ¿ä¸œçš„æœ€åé€šç‰’",
    when:(ctx)=>!ctx.win && ctx.evicted,
    body:(ctx)=>`ä½ ä¸æ˜¯è¾“ç»™äº†æŸä¸€å¼ ç‰Œï¼Œè€Œæ˜¯è¾“ç»™äº†â€œè¿™æœˆå…ˆæ‹–ä¸€ä¸‹â€çš„è¿å‡»ã€‚\n\næˆ¿ç§Ÿè¿™ä»¶äº‹å¾ˆç°å®ï¼šå®ƒä¸ä¼šå“ä½ ï¼Œå®ƒåªæ˜¯æŠŠä½ è¯·å‡ºå»ã€‚\n\nä½ ç¦»å¼€çš„æ—¶å€™è¿˜åœ¨æƒ³ï¼Œä¸‹æ¬¡ä¸€å®šå…ˆæŠŠä½å¤„ç¨³ä½ã€‚â€”â€”å¯æƒœï¼Œä¸‹æ¬¡è¦å…ˆæœ‰ä½å¤„ã€‚`
  },
  {
    id:"LOSE_COLLECTIONS",
    title:"ç»“å±€ï¼šå‚¬æ”¶äº¤å“ä¹",
    when:(ctx)=>!ctx.win && ctx.moneyBelowHard,
    body:(ctx)=>`æŸä¸€å¤©ä½ å‘ç°æ‰‹æœºæ¥ç”µåƒé›¨ç‚¹ï¼ŒçŸ­ä¿¡åƒé›¨ç‚¹ï¼Œé‚®ç®±ä¹Ÿæ˜¯é›¨ç‚¹ã€‚\n\nä½ å¼€å§‹å­¦ä¼šä¸€ä¸ªæ–°æŠ€èƒ½ï¼šçœ‹åˆ°æœªçŸ¥å·ç å°±å¿ƒè·³åŠ é€Ÿã€‚\n\nè¿™ä¸æ˜¯ä½ ä¸åŠªåŠ›ï¼Œåªæ˜¯ä½ åŠªåŠ›çš„æ–¹å‘å«â€œè¡¥æ´â€ï¼Œè€Œæ´çš„åå­—å«åˆ©æ¯ã€‚`
  },
  {
    id:"LOSE_STRESS",
    title:"ç»“å±€ï¼šç²¾ç¥ç”µé‡è€—å°½",
    when:(ctx)=>!ctx.win && ctx.stressZeroed,
    body:(ctx)=>`ä½ å€’ä¸‹çš„é‚£ä¸€åˆ»å¹¶ä¸æˆå‰§åŒ–ã€‚\n\nåªæ˜¯ä½ çªç„¶ä¸æƒ³å†è§£é‡Šã€ä¸æƒ³å†åŠªåŠ›ã€ä¸æƒ³å†â€œæ²¡äº‹â€ã€‚\n\nä½ ç»ˆäºæ‰¿è®¤äº†ï¼šå‹åŠ›ä¸æ˜¯ç”¨æ„å¿—è§£å†³çš„ï¼Œå®ƒéœ€è¦å‡ºå£ã€éœ€è¦æ”¯æŒã€ä¹Ÿéœ€è¦ä¼‘æ¯ã€‚`
  },
  {
    id:"LOSE_HEALTH",
    title:"ç»“å±€ï¼šèº«ä½“å…ˆæŠ•ç¥¨",
    when:(ctx)=>!ctx.win && ctx.healthZeroed,
    body:(ctx)=>`ä½ ä¸€ç›´ä»¥ä¸ºè‡ªå·±è¿˜èƒ½æ‰›ï¼Œç›´åˆ°èº«ä½“ç”¨æœ€ç®€å•çš„æ–¹å¼è®©ä½ åœä¸‹æ¥ã€‚\n\nå®ƒæ²¡æœ‰è·Ÿä½ å•†é‡ã€‚\n\nç°å®å°±æ˜¯è¿™æ ·ï¼šä½ å¯ä»¥ä¸ç…§é¡¾å¥åº·ï¼Œä½†å¥åº·ä¼šç…§é¡¾ä½ çš„æ—¶é—´è¡¨ã€‚`
  },
  {
    id:"LOSE_RELATIONSHIPS",
    title:"ç»“å±€ï¼šäººéƒ½æ•£äº†",
    when:(ctx)=>!ctx.win && (ctx.familyZeroed || ctx.friendZeroed),
    body:(ctx)=>`ä½ ä¸æ˜¯çªç„¶å˜å­¤ç‹¬çš„ã€‚\n\næ˜¯ä¸€å †â€œå°äº‹â€å †æˆäº†â€œç®—äº†â€ï¼Œä¸€å †â€œä¸‹æ¬¡â€å˜æˆäº†â€œå†ä¹Ÿæ²¡æœ‰â€ã€‚\n\nä½ å¾ˆåŠªåŠ›åœ¨æ´»ç€ï¼Œå¯æœ‰äººåªæ˜¯æƒ³è·Ÿä½ ä¸€èµ·ç”Ÿæ´»ã€‚`
  },
  {
    id:"LOSE_IMMIGRATION",
    title:"ç»“å±€ï¼šæ–‡ä»¶å¤¹é‡Œçš„å™©æ¢¦",
    when:(ctx)=>!ctx.win && ctx.hasImmigration,
    body:(ctx)=>`ä½ çš„äººç”Ÿè¢«å¤¹åœ¨ä¸¤é¡µçº¸ä¹‹é—´ã€‚\n\nä½ ä»¥ä¸ºåªè¦åŠªåŠ›å·¥ä½œå°±èƒ½å¾€å‰èµ°ï¼Œç»“æœå‘ç°è¿˜è¦åŠªåŠ›è§£é‡Šâ€œä½ ä¸ºä»€ä¹ˆåœ¨è¿™é‡Œâ€ã€‚\n\nåœ¨é‚£ä¸€å¤©ï¼Œä½ æ˜ç™½äº†ï¼šåˆ¶åº¦ä¸æ˜¯é’ˆå¯¹ä½ ï¼Œä½†å®ƒä¹Ÿä¸ä¼šä¸ºä½ åœä¸€ä¸‹ã€‚`
  },
  {
    id:"LOSE_LEGAL",
    title:"ç»“å±€ï¼šå¾‹å¸ˆå‡½çš„å‘³é“",
    when:(ctx)=>!ctx.win && ctx.hasLegal,
    body:(ctx)=>`ä½ çš„äººç”Ÿçªç„¶å¤šäº†ä¸€ä¸ªâ€œè¯·å‹¿å›å¤â€çš„ç« èŠ‚ã€‚\n\nä½ å¼€å§‹å­¦ä¼šçœ‹æ‡‚æ¡æ¬¾ï¼Œä¹Ÿå­¦ä¼šæŠŠæƒ…ç»ªæ”¾åœ¨è¯æ®åé¢ã€‚\n\nä½ ä¸ä¸€å®šæ˜¯é”™çš„ï¼Œä½†ä½ å‘ç°â€œå¯¹â€æœ‰æ—¶å€™ä¹Ÿå¾ˆè´µã€‚`
  },
  {
    id:"LOSE_CAR",
    title:"ç»“å±€ï¼šè½¦åäº†ï¼Œå·¥ä½œä¹Ÿè·Ÿç€åäº†",
    when:(ctx)=>!ctx.win && ctx.hasCarBroken && ctx.jobPressureHigh,
    body:(ctx)=>`ä½ ä½ä¼°äº†ä¸€ä¸ªåŒ—ç¾çœŸç†ï¼šè½¦ä¸æ˜¯äº¤é€šå·¥å…·ï¼Œæ˜¯ç”Ÿå­˜è®¸å¯è¯ã€‚\n\nå½“å®ƒç½¢å·¥çš„æ—¶å€™ï¼Œè¿Ÿåˆ°ã€è¯·å‡ã€æ‰£é’±ä¼šåƒå¤šç±³è¯ºéª¨ç‰Œä¸€æ ·æ¨å€’ä½ ã€‚\n\nä½ æœ€åçš„æ„Ÿæƒ³æ˜¯ï¼šä»¥åä¹°è½¦è¦é¡ºä¾¿ä¹°ä¸€ä»½â€œå¿ƒæ€â€ã€‚`
  },
  {
    id:"LOSE_DEBT_SPIRAL",
    title:"ç»“å±€ï¼šåˆ©æ¯çš„æ—‹è½¬æœ¨é©¬",
    when:(ctx)=>!ctx.win && ctx.debtLevel>=3,
    body:(ctx)=>`ä½ åä¸Šäº†å€ºåŠ¡çš„æ—‹è½¬æœ¨é©¬ï¼Œåˆšå¼€å§‹è¿˜è§‰å¾—æŒºæ¢¦å¹»ã€‚\n\nåæ¥ä½ å‘ç°å®ƒä¸ä¸‹è½¦ï¼šæ¯ä¸€åœˆéƒ½æ˜¯â€œæœ€ä½è¿˜æ¬¾â€ï¼Œæ¯ä¸€åœˆéƒ½æ›´è´µã€‚\n\nä½ ç»ˆäºæ‡‚äº†ï¼šå€ºåŠ¡ä¸æ˜¯é’±çš„é—®é¢˜ï¼Œæ˜¯æ—¶é—´è¢«æŠµæŠ¼çš„é—®é¢˜ã€‚`
  },

  // Mixed / neutral / comedic
  {
    id:"MIX_BROKE_BUT_ALIVE",
    title:"ç»“å±€ï¼šç©·ä½†æ´»ç€",
    when:(ctx)=>ctx.win && ctx.money<5000,
    body:(ctx)=>`ä½ é€šå…³äº†ï¼Œä½†é’±åŒ…åƒåˆšç»å†äº†ä¸€åœºå¤§è¿å¾™ã€‚\n\nä½ æ²¡èµ¢å¾—å¯Œæœ‰ï¼Œä½ èµ¢å¾—äº†ç”Ÿå­˜ã€‚\n\nå¦‚æœäººç”Ÿæœ‰æˆå°±ç³»ç»Ÿï¼Œä½ ç‚¹äº®äº†â€œè¿˜èƒ½å†æ’‘ä¸€ä¼šå„¿â€ã€‚`
  },
  {
    id:"MIX_SOLO",
    title:"ç»“å±€ï¼šå•æœºæ¨¡å¼é€šå…³",
    when:(ctx)=>ctx.win && ctx.socialSupport==0,
    body:(ctx)=>`ä½ ç‹¬è‡ªèµ°åˆ°äº†æœ€åã€‚\n\næ•ˆç‡å¾ˆé«˜ï¼Œæƒ…ç»ªå¾ˆå°‘ï¼Œç¤¾äº¤åŸºæœ¬é â€œå·²è¯»â€ã€‚\n\nä½ èµ¢å¾—äº†æŒæ§æ„Ÿï¼Œä¹Ÿå¤±å»äº†ä¸€äº›å¯ä»¥ä¸€èµ·åæ§½çš„äººã€‚`
  },
  {
    id:"MIX_ADMIN_HELL",
    title:"ç»“å±€ï¼šè¡Œæ”¿åœ°ç‹±æ—…æ¸¸å›¢",
    when:(ctx)=>ctx.win && ctx.adminHeavy>=6,
    body:(ctx)=>`ä½ çš„äººç”Ÿåƒä¸€ä¸ªè¡¨æ ¼ï¼šæ¯ä¸€åˆ—éƒ½è¦å¡«ï¼Œæ¯ä¸€æ ¼éƒ½è¦è¯æ˜ã€‚\n\nä½ é€šå…³çš„æ–¹å¼ä¸æ˜¯å‹‡æ•¢ï¼Œæ˜¯ç†Ÿç»ƒã€‚\n\nä½ å·²ç»å¯ä»¥é—­ç€çœ¼æŠŠæ‰€æœ‰æ–‡ä»¶å‘½åæˆâ€œFINAL_FINAL_v7â€ã€‚`
  },
  {
    id:"MIX_HEALTHY_POOR",
    title:"ç»“å±€ï¼šå¥åº·å¯Œç¿",
    when:(ctx)=>ctx.win && ctx.healthTier==="good" && ctx.money<12000,
    body:(ctx)=>`ä½ æ²¡æœ‰å¾ˆæœ‰é’±ï¼Œä½†ä½ å¾ˆæœ‰ç²¾ç¥ã€‚\n\nä½ æŠŠå¥åº·å½“æˆç¬¬ä¸€èµ„äº§ï¼Œç»“æœå‘ç°å®ƒç¡®å®èƒ½è®©å…¶ä»–èµ„äº§æ…¢æ…¢å›æ¥ã€‚\n\nä½ å¯èƒ½ä¸ä¼šç«‹åˆ»ç¿»èº«ï¼Œä½†ä½ è‡³å°‘ä¸ä¼šè¢«ç”Ÿæ´»ä¸€è„šè¸¹å€’ã€‚`
  },
  {
    id:"MIX_STRESSY_RICH",
    title:"ç»“å±€ï¼šå¯Œä½†ä¸å¿«ä¹",
    when:(ctx)=>ctx.win && ctx.money>=40000 && ctx.stressTier!=="good",
    body:(ctx)=>`é’±æ˜¯å¤Ÿçš„ï¼Œä½†ä½ æ€»è§‰å¾—å·®ä¸€ç‚¹ç‚¹ã€‚\n\nä½ æŠŠå®‰å…¨æ„Ÿå­˜è¿›è´¦æˆ·ï¼Œå´å‘ç°ç„¦è™‘ä¸æ”¯æŒè½¬è´¦ã€‚\n\nä½ å­¦ä¼šäº†ï¼šå¯Œä¸æ˜¯ç»ˆç‚¹ï¼Œæ”¾æ¾ä¹Ÿè¦ç»ƒä¹ ã€‚`
  },
  {
    id:"LOSE_GENERIC",
    title:"ç»“å±€ï¼šè¢«ç”Ÿæ´»æŒ‰äº†æš‚åœ",
    when:(ctx)=>!ctx.win,
    body:(ctx)=>`ä½ æ²¡èµ°åˆ°æœ€åï¼Œä½†è¿™ä¸ä»£è¡¨ä½ ä¸è¡Œã€‚\n\nåªæ˜¯è¿™ä¸€å±€ä½ æŠ½åˆ°çš„ç‰Œæ›´åƒâ€œç°å®ä¸»ä¹‰â€ï¼Œè€Œä½ éœ€è¦ä¸€ç‚¹â€œç³»ç»Ÿæ€§ç¼“å†²â€ã€‚\n\nä¸‹æ¬¡ä½ ä¼šæ›´æ—©ä¿®è¡¥å…³é”®çŸ­æ¿ï¼šä½å¤„ã€ç°é‡‘æµã€ä»¥åŠé‚£æ¡å«åšâ€œåˆ«ç¡¬æ‰›â€çš„åº•çº¿ã€‚`
  },
  {
    id:"WIN_GENERIC",
    title:"ç»“å±€ï¼šæ´»åˆ°æœ€åçš„äºº",
    when:(ctx)=>ctx.win,
    body:(ctx)=>`ä½ æ´»åˆ°äº†æœ€åã€‚\n\nä¸æ˜¯æ‰€æœ‰é€‰æ‹©éƒ½å®Œç¾ï¼Œä½†ä½ æ¯æ¬¡éƒ½åœ¨å´©ä¹‹å‰ï¼ŒæŠŠè‡ªå·±å¾€å›æ‹‰äº†ä¸€ç‚¹ã€‚\n\nä½ å­¦ä¼šäº†ä¸€ä¸ªæœ´ç´ çš„é“ç†ï¼šäººç”Ÿä¸æ˜¯ä¸çŠ¯é”™ï¼Œæ˜¯çŠ¯é”™åè¿˜èƒ½ç»§ç»­ã€‚`
  },
];

function summarizeRun(){
  const money = game.stats.money;
  const win = game.win;

  // tiers
  const healthTier = tierForPositiveStat(game.stats.health);
  const stressTier = tierForStress(game.stats.stress);
  const familyTier = tierForPositiveStat(game.stats.family);
  const friendTier = tierForPositiveStat(game.stats.friendship);

  // flags
  const has = (sid)=>!!game.active[sid] || game.choiceTexts.some(x=>x.id && (x.added||[]));
  const debtStates = ["S_CREDIT_CARD_DEBT","S_HIGH_INTEREST_LOAN","S_MEDICAL_DEBT","S_OVERDRAFT","S_COLLECTIONS_NOTICE"];
  const debtLevel = debtStates.reduce((a,sid)=>a + (game.active[sid] ? 1:0), 0);
  const socialSupport = (game.active["S_BEST_FRIEND_SUPPORT"]?1:0) + (game.active["S_SUPPORTIVE_PARTNER"]?1:0) + (game.stats.friendship>=70?1:0) + (game.stats.family>=70?1:0);
  const adminHeavy = (game.tagCounts.admin ?? 0);
  const bigGains = game.highlights.filter(h=>h.k==="big_gain").length;
  const bigSpends = game.highlights.filter(h=>h.k==="big_spend").length;

  const evicted = !!game.active["S_RENT_ARREARS"] && (game.counters.rent_arrears_months ?? 0) >= CONFIG.thresholds.eviction_months;
  const moneyBelowHard = game.stats.money < CONFIG.thresholds.money_hard;
  const stressZeroed = game.stats.stress >= 100;
  const healthZeroed = game.stats.health <= 0;
  const familyZeroed = game.stats.family <= 0;
  const friendZeroed = game.stats.friendship <= 0;

  const hasImmigration = !!game.active["S_IMMIGRATION_ISSUE"];
  const hasLegal = !!game.active["S_LEGAL_TROUBLE"];
  const hasCarBroken = !!game.active["S_CAR_BROKEN"];
  const jobPressureHigh = (game.tagCounts.job ?? 0) >= 10;

  return {
    win, money, healthTier, stressTier, familyTier, friendTier,
    debtLevel, socialSupport, adminHeavy, bigGains, bigSpends,
    evicted, moneyBelowHard, stressZeroed, healthZeroed, familyZeroed, friendZeroed,
    hasImmigration, hasLegal, hasCarBroken, jobPressureHigh,
    monthsSurvived: game.month,
  };
}

function pickEnding(ctx){
  for (const e of ENDINGS){
    if (e.when(ctx)) return e;
  }
  // fallback
  return ctx.win ? ENDINGS.find(x=>x.id==="WIN_GENERIC") : ENDINGS.find(x=>x.id==="LOSE_GENERIC");
}

function topTags(){
  const arr = Object.entries(game.tagCounts).sort((a,b)=>b[1]-a[1]);
  return arr.slice(0,3).map(([k,v])=>k);
}
function topStates(){
  // approximate: frequency of being present at end + mentions in highlights
  const count={};
  for (const sid of Object.keys(game.active)) count[sid]=(count[sid]??0)+3;
  for (const h of game.highlights){
    if (h.s) count[h.s]=(count[h.s]??0)+1;
  }
  return Object.entries(count).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([sid])=>sid);
}

function showEnding(){
  const ctx = summarizeRun();
  const e = pickEnding(ctx);

  const endTitle = document.getElementById("endTitle");
  const endBody = document.getElementById("endBody");
  const endBullets = document.getElementById("endBullets");
  const endNarrator = document.getElementById("endNarrator");

  endTitle.textContent = e.title;
  const moneyLine = `ï¼ˆæœ€ç»ˆç°é‡‘ï¼š${fmtMoney(ctx.money)} Â· å­˜æ´»ï¼š${ctx.monthsSurvived} ä¸ªæœˆï¼‰`;
  endBody.textContent = e.body(ctx) + "\n\n" + moneyLine;

  const tags = topTags();
  const states = topStates().map(sid => (STATE_ICON[sid] ?? "ğŸ§©") + " " + (stateIndex[sid]?.name ?? sid));
  const mood = `ä½ çš„çŠ¶æ€ç¯ï¼šå¥åº·=${ctx.healthTier} Â· å‹åŠ›=${ctx.stressTier} Â· å®¶åº­=${ctx.familyTier} Â· å‹æƒ…=${ctx.friendTier}`;
  const key = [
    `ä½ æœ€å¸¸é‡åˆ°çš„åœºæ™¯ï¼š${tags.length ? tags.join(" / ") : "ï¼ˆæ²¡ç»Ÿè®¡åˆ°ï¼Œè¯´æ˜ä½ çœŸçš„å¾ˆä¼šèº²ï¼‰"}`,
    `ä½ èƒŒè¿‡çš„â€œäººç”ŸåŒ…è¢±â€ï¼š${states.length ? states.join(" Â· ") : "å‡ ä¹æ²¡æœ‰ï¼ˆè¿™å¾ˆå°‘è§ï¼‰"}`,
    `ä½ å¯¹ç°é‡‘æµçš„æ€åº¦ï¼š${ctx.money>=30000 ? "è°¨æ…+æœ‰çºªå¾‹" : ctx.money>=12000 ? "èƒ½ç¨³ä½å¤§ç›˜" : ctx.money>=0 ? "æœˆå…‰ä½†æœ‰éŸ§æ€§" : "é å‹‡æ°”å’Œä¾¥å¹¸"}`,
    mood
  ];

  endBullets.innerHTML = key.map(x=>`<li>${x}</li>`).join("");

  // narrator: humorous meta based on highlights
  const narr = [];
  const missed = game.highlights.some(h=>h.k==="rent_missed");
  const paid = game.highlights.filter(h=>h.k==="rent_paid").length;
  if (missed) narr.push("å‘½è¿ï¼šä½ å¯¹æˆ¿ç§Ÿçš„æ€åº¦åƒå¯¹é—¹é’Ÿï¼ŒæŒ‰æ‰ä¸ä»£è¡¨å®ƒä¸å­˜åœ¨ã€‚");
  else narr.push("å‘½è¿ï¼šä½ è‡³å°‘å¯¹æˆ¿ç§Ÿå¾ˆè¯šå®ï¼Œè¿™æ˜¯å¾ˆå¤šäººåšä¸åˆ°çš„ã€‚");
  if (ctx.debtLevel>=2) narr.push("å‘½è¿ï¼šä½ ä¸æ˜¯æ€•å€ºï¼Œä½ åªæ˜¯å¯¹åˆ©æ¯æ²¡æ¦‚å¿µã€‚ç°åœ¨æœ‰äº†ã€‚");
  if (ctx.socialSupport>=3) narr.push("å‘½è¿ï¼šä½ çš„äººé™…å…³ç³»åƒä¿é™©ï¼Œè´µçš„æ—¶å€™ä½ å«Œå®ƒçƒ¦ï¼Œå‡ºäº‹æ—¶ä½ çˆ±å®ƒã€‚");
  if (ctx.adminHeavy>=8) narr.push("å‘½è¿ï¼šä½ çš„æ•…äº‹é‡Œæœ€å¤§çš„åæ´¾ä¸æ˜¯äººï¼Œæ˜¯â€œéœ€è¦è¡¥å……ææ–™â€ã€‚");
  if (ctx.bigGains>=2) narr.push("å‘½è¿ï¼šå¥½è¿ä¸æ˜¯å¥–åŠ±ï¼Œæ˜¯æµ‹è¯•ä½ ä¼šä¸ä¼šé£˜ã€‚ä½ â€¦å¤§ä½“é€šè¿‡äº†ã€‚");
  if (ctx.bigSpends>=2) narr.push("å‘½è¿ï¼šä½ æ¯æ¬¡å¤§é¢æ”¯å‡ºå‰éƒ½åƒåœ¨è¯´â€˜å°±è¿™ä¸€æ¬¡â€™ï¼Œä½†å‘½è¿å¬å¤šäº†ã€‚");
  narr.push("å‘½è¿ï¼šäººç”Ÿæ²¡æœ‰æœ€ä¼˜è§£ï¼Œåªæœ‰ä½ æ„¿æ„æ‰¿æ‹…çš„åæœã€‚ä½ å·²ç»åšå¾—å¾ˆåƒä¸€ä¸ªæˆå¹´äººäº†ã€‚");

  endNarrator.innerHTML = narr.slice(0,5).map(x=>`<li>${x}</li>`).join("");

  showOverlay();
}

const overlay = document.getElementById("overlay");
function showOverlay(){ overlay.classList.add("show"); }
function hideOverlay(){ overlay.classList.remove("show"); }

document.getElementById("btnAgain").onclick = ()=>{ hideOverlay(); resetUI(); newGame(); };

/* ====== Loading ====== */
async function readJsonFromFileInput(inputEl){
  return new Promise((resolve,reject)=>{
    const f=inputEl.files?.[0]; if(!f) return resolve(null);
    const fr=new FileReader();
    fr.onload=()=>{ try{ resolve(JSON.parse(fr.result)); } catch(e){ reject(e); } };
    fr.onerror=reject;
    fr.readAsText(f,"utf-8");
  });
}
async function tryFetchJson(path){
  try{ const r=await fetch(path,{cache:"no-store"}); if(!r.ok) return null; return await r.json(); }
  catch(e){ return null; }
}
async function loadData(){
  const fe=document.getElementById("fileEvents");
  const fs=document.getElementById("fileStates");
  const fc=document.getElementById("fileConfig");

  let je=await readJsonFromFileInput(fe);
  let js=await readJsonFromFileInput(fs);
  let jc=await readJsonFromFileInput(fc);

  if(!je) je=await tryFetchJson("./events.json");
  if(!js) js=await tryFetchJson("./states.json");
  if(!jc) jc=await tryFetchJson("./config.json");

  if(!je||!js||!jc){
    alert("åŠ è½½å¤±è´¥ï¼šè¯·ç”¨æ–‡ä»¶é€‰æ‹©å™¨é€‰æ‹© events/states/configï¼Œæˆ–ç”¨æœ¬åœ°æœåŠ¡å™¨æ‰“å¼€å¹¶æŠŠä¸‰ä¸ª json æ”¾åŒç›®å½•ã€‚");
    return;
  }
  EVENTS = je.events ?? je;
  STATES = js.states ?? js;
  CONFIG = (jc.config ?? jc);

  if(!CONFIG.economy) CONFIG.economy = {};
  if(!("base_paycheck" in CONFIG.economy)){
    const pay = (STATES.find(s=>s.id==="S_PAYCHECK")?.monthly_effect?.money) ?? 0;
    CONFIG.economy.base_paycheck = pay;
  }

  rebuildPools();
  buildStateIndex();

  if(stateIndex["S_PAYCHECK"]){
    stateIndex["S_PAYCHECK"].monthly_effect = stateIndex["S_PAYCHECK"].monthly_effect || {};
    stateIndex["S_PAYCHECK"].monthly_effect.money = CONFIG.economy.base_paycheck;
  }

  document.getElementById("btnNew").disabled=false;
  document.getElementById("btnReset").disabled=false;
  showToast(`åŠ è½½å®Œæˆï¼šäº‹ä»¶ ${EVENTS.length} å¼ ï¼ŒçŠ¶æ€ ${STATES.length} ä¸ªã€‚å¼€å§‹å§ã€‚`);
}

document.getElementById("btnLoad").onclick = loadData;
document.getElementById("btnNew").onclick = ()=>{ resetUI(); newGame(); };
document.getElementById("btnReset").onclick = ()=>{ resetUI(); game=null; document.getElementById("moneyVal").textContent="â€”"; document.getElementById("progressText").textContent="â€”"; hideOverlay(); };

/* auto load if server mode */
(async ()=>{
  const je=await tryFetchJson("./events.json");
  const js=await tryFetchJson("./states.json");
  const jc=await tryFetchJson("./config.json");
  if(je&&js&&jc){
    EVENTS=je.events ?? je;
    STATES=js.states ?? js;
    CONFIG=(jc.config ?? jc);
    if(!CONFIG.economy) CONFIG.economy = {};
    if(!("base_paycheck" in CONFIG.economy)){
      const pay = (STATES.find(s=>s.id==="S_PAYCHECK")?.monthly_effect?.money) ?? 0;
      CONFIG.economy.base_paycheck = pay;
    }
    rebuildPools(); buildStateIndex();
    if(stateIndex["S_PAYCHECK"]){
      stateIndex["S_PAYCHECK"].monthly_effect = stateIndex["S_PAYCHECK"].monthly_effect || {};
      stateIndex["S_PAYCHECK"].monthly_effect.money = CONFIG.economy.base_paycheck;
    }
    document.getElementById("btnNew").disabled=false;
    document.getElementById("btnReset").disabled=false;
    showToast("å·²è‡ªåŠ¨åŠ è½½æ•°æ®ã€‚ç‚¹å‡»ã€Œå¼€å§‹äººç”Ÿã€ã€‚");
  }
})();
</script>
</body>
</html>
